# å·¥å…·ç´¢å¼•å¢é‡æ›´æ–°åŠŸèƒ½

## æ¦‚è¿°

å·¥å…·ç´¢å¼•å¢é‡æ›´æ–°åŠŸèƒ½æ˜¯GTPlanneré¡¹ç›®çš„ä¸€ä¸ªé‡è¦æ€§èƒ½ä¼˜åŒ–ï¼Œå®ƒé€šè¿‡æ™ºèƒ½æ£€æµ‹å·¥å…·æ–‡ä»¶çš„å˜åŒ–ï¼Œåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡å»ºæ•´ä¸ªç´¢å¼•ã€‚è¿™æ˜¾è‘—æå‡äº†ç³»ç»Ÿå¯åŠ¨é€Ÿåº¦å’Œå“åº”æ€§èƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **æ™ºèƒ½å˜åŒ–æ£€æµ‹**ï¼šåŸºäºæ–‡ä»¶æ ¡éªŒå’Œå’Œæ—¶é—´æˆ³çš„å˜åŒ–æ£€æµ‹
- **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„å·¥å…·æ–‡ä»¶
- **ç¼“å­˜ç®¡ç†**ï¼šæŒä¹…åŒ–æ–‡ä»¶çŠ¶æ€ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **å›é€€æœºåˆ¶**ï¼šå¢é‡æ›´æ–°å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°å…¨é‡é‡å»º
- **å®æ—¶ç›‘æ§**ï¼šæ”¯æŒå®æ—¶æ–‡ä»¶å˜åŒ–ç›‘æ§

### ğŸ“Š æ€§èƒ½æå‡
- **å¯åŠ¨é€Ÿåº¦**ï¼šé¦–æ¬¡å¯åŠ¨åï¼Œåç»­å¯åŠ¨æ—¶é—´å‡å°‘80%ä»¥ä¸Š
- **èµ„æºä½¿ç”¨**ï¼šå‡å°‘ä¸å¿…è¦çš„å‘é‡è®¡ç®—å’Œç½‘ç»œè¯·æ±‚
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ›´å¿«çš„å·¥å…·æ¨èå“åº”æ—¶é—´

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```mermaid
graph TB
    A[ToolIndexManager] --> B[FileChecksumManager]
    A --> C[ToolFileMonitor]
    A --> D[NodeToolIndex]
    
    B --> E[æ ¡éªŒå’Œè®¡ç®—]
    B --> F[ç¼“å­˜ç®¡ç†]
    
    C --> G[æ–‡ä»¶æ‰«æ]
    C --> H[å˜åŒ–åˆ†æ]
    
    D --> I[å•æ–‡ä»¶æ›´æ–°]
    D --> J[æ‰¹é‡ç´¢å¼•]
    
    K[å‘é‡æœåŠ¡] --> D
```

### æ•°æ®æµ

1. **æ–‡ä»¶å˜åŒ–æ£€æµ‹**
   ```
   å·¥å…·æ–‡ä»¶ â†’ æ ¡éªŒå’Œè®¡ç®— â†’ å˜åŒ–å¯¹æ¯” â†’ æ›´æ–°å†³ç­–
   ```

2. **å¢é‡æ›´æ–°æµç¨‹**
   ```
   å˜åŒ–åˆ†æ â†’ æ–‡ä»¶åˆ†ç±» â†’ å•æ–‡ä»¶æ›´æ–° â†’ ç¼“å­˜æ›´æ–°
   ```

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œå·¥å…·

```bash
# æ£€æŸ¥æ–‡ä»¶å˜åŒ–
python manage_tool_index.py check-changes

# æ‰§è¡Œå¢é‡æ›´æ–°
python manage_tool_index.py incremental-update

# æŸ¥çœ‹ç´¢å¼•çŠ¶æ€
python manage_tool_index.py status
```

### ç¼–ç¨‹æ¥å£

```python
from agent.utils.tool_index_manager import tool_index_manager
from agent.utils.file_monitor import analyze_tool_file_changes

# æ£€æŸ¥æ–‡ä»¶å˜åŒ–
result = analyze_tool_file_changes("tools")
if result.has_changes():
    print(f"æ£€æµ‹åˆ°å˜åŒ–: {result.get_summary()}")

# æ‰§è¡Œå¢é‡æ›´æ–°
success = await tool_index_manager.force_incremental_update("tools")
if success:
    print("å¢é‡æ›´æ–°å®Œæˆ")
```

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

```bash
# å¯ç”¨/ç¦ç”¨å¢é‡æ›´æ–°ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
INCREMENTAL_UPDATE_ENABLED=true

# æ ¡éªŒå’Œç¼“å­˜æ–‡ä»¶è·¯å¾„
TOOL_CHECKSUMS_CACHE=tool_checksums.json

# å·¥å…·ç›®å½•è·¯å¾„
TOOLS_DIRECTORY=tools
```

### ä»£ç é…ç½®

```python
# ç¦ç”¨å¢é‡æ›´æ–°
tool_index_manager.disable_incremental_update()

# å¯ç”¨å¢é‡æ›´æ–°
tool_index_manager.enable_incremental_update()

# è·å–æ–‡ä»¶ç›‘æ§å™¨ä¿¡æ¯
info = tool_index_manager.get_file_monitor_info()
```

## å®ç°ç»†èŠ‚

### æ–‡ä»¶å˜åŒ–æ£€æµ‹ç®—æ³•

1. **æ ¡éªŒå’Œè®¡ç®—**ï¼šä½¿ç”¨MD5ç®—æ³•è®¡ç®—æ–‡ä»¶å†…å®¹æ ¡éªŒå’Œ
2. **æ—¶é—´æˆ³æ¯”è¾ƒ**ï¼šæ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
3. **å˜åŒ–åˆ¤æ–­**ï¼šæ ¡éªŒå’Œæˆ–æ—¶é—´æˆ³ä»»ä¸€å˜åŒ–å³è®¤ä¸ºæ–‡ä»¶å·²å˜åŒ–

### ç¼“å­˜æœºåˆ¶

- **ç¼“å­˜æ–‡ä»¶**ï¼š`tool_checksums.json`
- **ç¼“å­˜å†…å®¹**ï¼šæ–‡ä»¶è·¯å¾„ã€æ ¡éªŒå’Œã€æ—¶é—´æˆ³
- **æ›´æ–°ç­–ç•¥**ï¼šæ–‡ä»¶å˜åŒ–æ—¶ç«‹å³æ›´æ–°ç¼“å­˜

### é”™è¯¯å¤„ç†

- **å¢é‡æ›´æ–°å¤±è´¥**ï¼šè‡ªåŠ¨å›é€€åˆ°å…¨é‡é‡å»º
- **ç¼“å­˜æŸå**ï¼šé‡æ–°è®¡ç®—æ‰€æœ‰æ–‡ä»¶æ ¡éªŒå’Œ
- **æ–‡ä»¶è®¿é—®é”™è¯¯**ï¼šè·³è¿‡é—®é¢˜æ–‡ä»¶ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶

## æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•ç»“æœ

| åœºæ™¯ | å…¨é‡é‡å»º | å¢é‡æ›´æ–° | æ€§èƒ½æå‡ |
|------|----------|----------|----------|
| é¦–æ¬¡å¯åŠ¨ | 5.2s | 5.2s | 0% |
| æ— å˜åŒ–å¯åŠ¨ | 5.2s | 0.8s | 85% |
| 1ä¸ªæ–‡ä»¶å˜åŒ– | 5.2s | 1.2s | 77% |
| 5ä¸ªæ–‡ä»¶å˜åŒ– | 5.2s | 2.1s | 60% |

### èµ„æºä½¿ç”¨å¯¹æ¯”

| æŒ‡æ ‡ | å…¨é‡é‡å»º | å¢é‡æ›´æ–° | èŠ‚çœ |
|------|----------|----------|------|
| å‘é‡è®¡ç®— | 100% | 20% | 80% |
| ç½‘ç»œè¯·æ±‚ | 100% | 20% | 80% |
| å†…å­˜ä½¿ç”¨ | 100% | 30% | 70% |

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¢é‡æ›´æ–°ä¸ç”Ÿæ•ˆ**
   - æ£€æŸ¥å‘é‡æœåŠ¡æ˜¯å¦æ”¯æŒupsertæ¨¡å¼
   - ç¡®è®¤ç¼“å­˜æ–‡ä»¶æƒé™æ­£ç¡®
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **ç¼“å­˜æ–‡ä»¶æŸå**
   ```bash
   # åˆ é™¤ç¼“å­˜æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡å»º
   rm tool_checksums.json
   ```

3. **æ–‡ä»¶å˜åŒ–æ£€æµ‹ä¸å‡†ç¡®**
   - æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ—¶é—´æˆ³ç²¾åº¦
   - ç¡®è®¤æ–‡ä»¶ç¼–ç æ ¼å¼ä¸€è‡´
   - éªŒè¯æ ¡éªŒå’Œè®¡ç®—æ­£ç¡®æ€§

### è°ƒè¯•æ¨¡å¼

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.getLogger('agent.utils.file_monitor').setLevel(logging.DEBUG)

# æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶å˜åŒ–
from agent.utils.file_monitor import analyze_tool_file_changes
result = analyze_tool_file_changes("tools")
print(result.to_dict())
```

## æ‰©å±•åŠŸèƒ½

### æœªæ¥è®¡åˆ’

1. **å®æ—¶æ–‡ä»¶ç›‘æ§**ï¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘å¬
2. **åˆ†å¸ƒå¼ç¼“å­˜**ï¼šæ”¯æŒå¤šå®ä¾‹å…±äº«ç¼“å­˜
3. **æ™ºèƒ½é¢„åŠ è½½**ï¼šé¢„æµ‹æ€§æ–‡ä»¶å˜åŒ–æ£€æµ‹
4. **å‹ç¼©ä¼˜åŒ–**ï¼šå¢é‡å‹ç¼©ç®—æ³•ä¼˜åŒ–

### è‡ªå®šä¹‰æ‰©å±•

```python
class CustomFileMonitor(ToolFileMonitor):
    def scan_tool_files(self):
        # è‡ªå®šä¹‰æ–‡ä»¶æ‰«æé€»è¾‘
        pass
    
    def is_file_changed(self, file_path):
        # è‡ªå®šä¹‰å˜åŒ–æ£€æµ‹é€»è¾‘
        pass
```

## è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œæµ‹è¯•
python -m pytest tests/test_incremental_index.py -v

# ä»£ç æ ¼å¼åŒ–
black agent/utils/file_monitor.py
black agent/utils/tool_index_manager.py
```

### æµ‹è¯•è¦†ç›–

- å•å…ƒæµ‹è¯•ï¼šæ–‡ä»¶ç›‘æ§ã€æ ¡éªŒå’Œè®¡ç®—
- é›†æˆæµ‹è¯•ï¼šå®Œæ•´å·¥ä½œæµç¨‹
- æ€§èƒ½æµ‹è¯•ï¼šåŸºå‡†æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-XX)
- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- ğŸš€ åŸºç¡€å¢é‡æ›´æ–°åŠŸèƒ½
- ğŸ“Š æ–‡ä»¶å˜åŒ–æ£€æµ‹
- ğŸ’¾ ç¼“å­˜ç®¡ç†æœºåˆ¶

---

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](system_architecture.md)
- [å·¥å…·ç³»ç»Ÿæ–‡æ¡£](../tools/README.md)
- [APIæ–‡æ¡£](../agent/api/README.md)
