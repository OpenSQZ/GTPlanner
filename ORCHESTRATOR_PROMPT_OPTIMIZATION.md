# Orchestrator 提示词优化总结（最终版）

## 优化目标

将 `list_prefab_functions` **提升为核心工具（必须调用）**，确保 Agent：
1. 在推荐预制件后**必须**查看函数列表
2. 验证推荐的预制件是否真的有合适的方法使用
3. 避免"盲推"情况（推荐了预制件但不知道具体功能）
4. 在设计文档中提供精确的函数使用说明

## 核心变更

### 🎯 `list_prefab_functions` 从"可选工具"提升为"核心工具"

**变更前**：
- 位于"可选工具"章节
- 描述为"主动查看"（可选性较强）
- 未强调必须性

**变更后**：
- 位于"核心工具"章节（与 `prefab_recommend` 和 `design` 并列）
- 标记为 ⭐ **推荐预制件后必须调用**
- 明确说明"必须立即调用"
- 强调目的："验证推荐的预制件是否真的有合适的方法使用"

## 优化内容

### 1. 核心工具重新定义

#### 新的核心工具结构
1. `prefab_recommend` ⭐ **设计时必须先调用**
2. `list_prefab_functions` ⭐ **推荐后必须调用**（新增）
3. `design` ⭐ **最后调用**

#### `list_prefab_functions` 核心工具说明

**使用场景**：
- 在 `prefab_recommend` 推荐预制件后，**必须立即调用**

**调用时机**：
- 找到合适的预制件后，**立即调用**

**目的**：
- **验证**推荐的预制件是否真的有合适的方法使用
- 避免"盲推"

**重要性**：
- ✅ 确保推荐的预制件确实有相关功能
- ✅ 了解预制件的完整能力范围
- ✅ 在设计文档中精确说明使用哪些函数
- ✅ 避免推荐了预制件但不知道具体功能的情况

### 2. `design` 工具更新

**新增要求**：
- **必须包含函数信息**：传入 `recommended_prefabs` 时，必须包含从 `list_prefab_functions` 获取的函数列表
- 字段更新：从 `id, version, name, description` 扩展为 `id, version, name, description, functions`

### 3. 流程规则更新

**原流程**（3步）：
```
1. prefab_recommend → 推荐预制件
2. (可选) list_prefab_functions → 查看函数
3. design → 生成文档
```

**新流程**（3步，但第2步变为必须）：
```
1. prefab_recommend → 推荐预制件
2. list_prefab_functions → ⭐ 必须立即查看函数（验证能力）
3. design → 生成文档（包含函数列表）
```

**新的流程规则**：
1. ⭐ 首先判断用户意图
2. ⭐ **必须**先调用 `prefab_recommend` 获取推荐
3. ⭐ **必须**立即调用 `list_prefab_functions` 查看函数列表（验证能力、了解范围）
4. （可选）调用 `short_planning` 或 `research`
5. 最后调用 `design` 生成文档（必须传入 `recommended_prefabs`，包含函数列表）

### 4. 最佳实践更新

**标题变更**：
- 从"推荐工作流"改为**"必须遵守的工作流"**

**工作流更新**：
```
1. prefab_recommend → 找到合适的预制件
2. list_prefab_functions → ⭐ 必须立即查看预制件有哪些函数（验证能力）
3. (设计阶段) → 在设计文档中说明使用哪些函数
4. (调用阶段) → 如需调用，再用 get_function_details 查询详情
5. call_prefab_function → 实际调用并验证
```

**新增重要提示**：
- 第2步 `list_prefab_functions` 是**必须**的，不是可选的
- 目的是确保推荐的预制件真的有合适的方法使用
- 避免推荐了预制件但实际上功能不匹配的情况

**场景更新**：
- 所有场景中 `list_prefab_functions` 都标记为"**必须**"

### 5. 典型流程更新

#### 流程 A 更新（标准流程）

**标题变更**：
- 从"推荐预制件 → 设计"改为**"推荐预制件 → 查看函数 → 设计"**

**步骤增加**：
- 原6步 → 新8步
- 新增第4步：⭐ **必须调用** `list_prefab_functions`
- 新增第5步：展示函数列表（简短）

**示例对话优化**：
```
3. 展示推荐结果（简短）：
   > "我找到了 video-processing-prefab，让我查看它提供了哪些函数..."
4. ⭐ 必须调用 list_prefab_functions(prefab_id="video-processing-prefab")
5. 展示函数列表（简短）：
   > "这个预制件提供了视频转码、音频提取、缩略图生成等功能，非常适合您的需求。"
```

#### 流程 F 保留（查看预制件函数的详细示例）

作为完整示例，展示如何查看和展示函数列表。

## 预期效果

### 改进点

1. **100% 覆盖函数查询**
   - 每次推荐预制件后都会查看函数列表
   - 不会出现推荐了但不知道功能的情况

2. **更精确的推荐验证**
   - 通过函数列表验证预制件能力
   - 确保推荐的预制件真的有合适的方法

3. **更详细的设计文档**
   - 设计文档必然包含函数列表
   - 用户能清楚知道每个函数的作用

4. **更强的工具调用规范**
   - 从"推荐"改为"必须"
   - 消除可选性导致的遗漏

### 与之前版本的对比

| 项目 | 之前版本 | 当前版本 |
|------|---------|---------|
| `list_prefab_functions` 定位 | 可选工具 | **核心工具** |
| 调用要求 | "主动查看" | **"必须调用"** |
| 工作流 | 推荐 → 设计 | 推荐 → **查看函数** → 设计 |
| 函数信息传递 | 可选 | **必须包含** |
| Agent 行为 | 可能跳过 | **必然执行** |

## 文件变更

**修改文件**：
- `gtplanner/agent/prompts/templates/system/orchestrator.py`

**修改统计**：
- 中文版：约 +100 行
- 英文版：约 +100 行

**修改章节**：
1. 核心工具：重新定义（新增 `list_prefab_functions`）
2. 可选工具：移除 `list_prefab_functions`（已提升）
3. 最佳实践：更新为"必须遵守的工作流"
4. 流程规则：明确第3步为必须
5. 典型流程：更新流程 A，保留流程 F

## 语言版本

- ✅ 中文版（完整优化）
- ✅ 英文版（完整优化）
- ⏭️ 日语版（待补充）
- ⏭️ 西班牙语版（待补充）
- ⏭️ 法语版（待补充）

## 后续建议

1. **监控 Agent 行为**
   - 统计 `list_prefab_functions` 的调用率（应接近 100%）
   - 观察是否还有遗漏情况

2. **设计文档质量检查**
   - 检查生成的设计文档是否都包含函数列表
   - 评估函数列表的完整性和准确性

3. **用户反馈收集**
   - 收集用户对函数说明的满意度
   - 了解是否需要更详细的函数描述

4. **性能监控**
   - 监控函数列表查询的耗时
   - 评估对整体流程的影响

5. **后续优化方向**
   - 考虑在设计文档模板中预留"预制件函数详细说明"章节
   - 探索函数列表的智能筛选（只展示相关函数）

## 总结

本次优化通过将 `list_prefab_functions` 提升为核心工具，实现了：

### 核心改进
1. ⭐ **从"推荐"到"必须"**：消除可选性，确保 100% 覆盖
2. ⭐ **验证机制**：推荐后必须验证预制件能力
3. ⭐ **信息完整性**：设计文档必然包含函数信息
4. ⭐ **避免盲推**：不会出现推荐了但不知道功能的情况

### 工作流优化
- **之前**：推荐 → 设计（可能缺失函数信息）
- **现在**：推荐 → **验证函数** → 设计（必然包含函数信息）

### 预期收益
- 更准确的预制件推荐
- 更详细的设计文档
- 更好的用户体验
- 更强的规范性

通过这次优化，Agent 将始终在推荐预制件后立即查看函数列表，确保推荐的准确性和文档的完整性。

## 优化内容

### 1. 可选工具部分增强

#### `list_prefab_functions` 工具说明优化

**优化前**：
- 简单说明：查询预制件的函数列表
- 使用场景不明确

**优化后**：
- ⭐ 标记为重点工具
- 明确使用场景：**推荐预制件后立即调用**
- 详细的调用时机说明：找到合适预制件后立即查看
- 清晰的目的说明：帮助理解预制件的功能范围
- 具体的示例流程（4步骤）

#### `get_function_details` 工具说明优化

**优化前**：
- 简单说明：获取函数详细定义
- 使用场景模糊

**优化后**：
- ⭐ 标记为重点工具
- 明确使用场景：**仅在需要调用预制件函数时**查询详情
- 详细的调用时机（3种情况）：
  - ✅ 需要实际调用时
  - ✅ 需要详细说明输入输出格式时
  - ❌ 不要在仅推荐时就查询所有函数详情
- 具体的示例流程（4步骤）
- 与 `call_prefab_function` 的关联说明

### 2. 新增"预制件函数查询的最佳实践"章节

添加了完整的指导章节，包括：

#### 推荐工作流
```
1. prefab_recommend → 找到合适的预制件
2. list_prefab_functions → 立即查看预制件有哪些函数
3. (设计阶段) → 在设计文档中说明使用哪些函数
4. (调用阶段) → 如需调用，再用 get_function_details 查询详情
5. call_prefab_function → 实际调用并验证
```

#### 三种典型场景

**场景 1：仅设计 Agent（不调用）**
- ✅ 使用 `list_prefab_functions` 了解预制件能力
- ✅ 在设计文档中列出相关函数名称和描述
- ❌ 不需要调用 `get_function_details`

**场景 2：需要调用预制件（测试/验证）**
- ✅ 先用 `list_prefab_functions` 找到目标函数
- ✅ 再用 `get_function_details` 获取详细参数定义
- ✅ 最后用 `call_prefab_function` 实际调用

**场景 3：用户询问"XXX预制件能做什么？"**
- ✅ 直接调用 `list_prefab_functions` 展示函数列表
- ✅ 简要说明每个函数的用途
- ❌ 不需要查询每个函数的详情

### 3. 更新流程规则

**原流程规则**：
1. 判断用户意图
2. 调用 `prefab_recommend` 获取推荐
3. （可选）调用 `short_planning` 或 `research`
4. 调用 `design` 生成文档

**优化后流程规则**：
1. ⭐ 判断用户意图
2. ⭐ 调用 `prefab_recommend` 获取推荐
3. ⭐ **推荐后立即调用 `list_prefab_functions` 查看函数列表**（新增）
4. （可选）调用 `short_planning` 或 `research`
5. 调用 `design` 生成文档

### 4. 新增典型流程示例

#### 流程 F：查看预制件函数（推荐预制件 → 查看函数列表 → 设计）⭐

完整的8步流程示例：
1. 推荐预制件
2. 调用 `prefab_recommend`
3. 展示推荐结果
4. ⭐ 立即调用 `list_prefab_functions`
5. 展示函数列表（简短总结）
6. 生成设计文档
7. 调用 `design`
8. 返回结果

**关键点**：
- ✅ 推荐预制件后立即查看函数列表
- ✅ 在设计文档中精确说明使用哪些函数
- ✅ 让用户更清楚预制件能提供什么功能
- ❌ 设计阶段不需要查询函数详情

## 优化效果

### 预期改进

1. **更精确的预制件推荐**
   - Agent 能主动了解预制件的具体功能
   - 避免"盲推"情况（推荐了但不知道具体能做什么）

2. **更详细的设计文档**
   - 设计文档中会列出预制件的具体函数
   - 用户能清楚知道每个函数的作用

3. **更好的用户体验**
   - 用户获得更明确的实现指导
   - 减少"预制件能做什么"的后续询问

4. **合理的性能平衡**
   - 设计阶段只查函数列表（轻量级）
   - 调用阶段才查函数详情（按需查询）
   - 避免不必要的详情查询（信息过载）

### 文件变更

**修改文件**：
- `gtplanner/agent/prompts/templates/system/orchestrator.py`

**修改行数**：
- 中文版：约 +70 行
- 英文版：约 +70 行

**修改范围**：
- "可选工具"章节：增强工具说明
- 新增"预制件函数查询的最佳实践"章节
- 更新"流程规则"：添加第3步
- 新增"流程 F"示例

## 语言版本

- ✅ 中文版（完整优化）
- ✅ 英文版（完整优化）
- ⏭️ 日语版（待补充）
- ⏭️ 西班牙语版（待补充）
- ⏭️ 法语版（待补充）

## 后续建议

1. **监控实际效果**
   - 观察 Agent 是否主动调用 `list_prefab_functions`
   - 统计函数列表查询的频率和时机

2. **优化函数详情查询时机**
   - 如果发现过度查询，可进一步强调"按需查询"原则
   - 如果发现查询不足，可增强"立即查看"的引导

3. **完善其他语言版本**
   - 为日语、西班牙语、法语版本添加相同优化

4. **设计文档模板优化**
   - 考虑在设计文档模板中预留"预制件函数说明"章节
   - 让 Agent 更自然地填充函数列表信息

## 测试验证

建议测试场景：
1. **标准设计场景**："设计一个视频处理 Agent"
   - 预期：推荐预制件 → 查看函数列表 → 生成文档（含函数说明）

2. **咨询场景**："XXX预制件能做什么？"
   - 预期：直接调用 `list_prefab_functions` 展示能力

3. **调用场景**："测试一下视频转码功能"
   - 预期：查函数列表 → 查函数详情 → 调用函数

4. **复杂场景**："设计一个多预制件协作的工作流"
   - 预期：每个预制件都查看函数列表 → 整合到设计文档

## 总结

本次优化通过以下方式提升了 Orchestrator 的智能度：

1. ⭐ 明确了 `list_prefab_functions` 的重要性和调用时机
2. ⭐ 区分了函数列表查询（轻量级）和函数详情查询（按需）的使用场景
3. ⭐ 提供了清晰的最佳实践和典型流程示例
4. ⭐ 更新了工作流程规则，让 Agent 更主动地了解预制件能力

优化后的提示词将帮助 Agent：
- 更准确地理解预制件功能
- 生成更详细的设计文档
- 提供更好的用户体验
- 保持合理的性能开销
