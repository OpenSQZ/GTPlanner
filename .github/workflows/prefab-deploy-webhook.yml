name: Prefab Deploy on Merge

# å½“ PR åˆå¹¶åˆ° main æ—¶è§¦å‘éƒ¨ç½²ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
    paths:
      - 'prefabs/releases/community-prefabs.json'
  workflow_dispatch:
    inputs:
      prefab_id:
        description: 'Prefab ID to deploy (e.g., llm-client)'
        required: true
        type: string
      version:
        description: 'Version to deploy (e.g., 1.0.1)'
        required: true
        type: string

jobs:
  trigger-deployment:
    name: Trigger Prefab Factory Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿å¯¹æ¯”ï¼ˆä»…åœ¨ push è§¦å‘æ—¶éœ€è¦ï¼‰

      - name: Extract changed entry
        id: extract
        env:
          MANUAL_PREFAB_ID: ${{ github.event.inputs.prefab_id }}
          MANUAL_VERSION: ${{ github.event.inputs.version }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          import os

          manual_prefab_id = os.environ.get('MANUAL_PREFAB_ID')
          manual_version = os.environ.get('MANUAL_VERSION')

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘
          if manual_prefab_id and manual_version:
              print(f"ğŸ”§ Manual deployment triggered for {manual_prefab_id}@{manual_version}")
              
              # ä» community-prefabs.json ä¸­è¯»å–æŒ‡å®šçš„ prefab
              with open('prefabs/releases/community-prefabs.json') as f:
                  all_prefabs = json.load(f)
              
              # æŸ¥æ‰¾åŒ¹é…çš„ prefab
              target_prefab = None
              for prefab in all_prefabs:
                  if prefab['id'] == manual_prefab_id and prefab['version'] == manual_version:
                      target_prefab = prefab
                      break
              
              if not target_prefab:
                  print(f"::error::Prefab {manual_prefab_id}@{manual_version} not found in community-prefabs.json")
                  sys.exit(1)
              
              changed = [target_prefab]
              print(f"âœ“ Found prefab: {target_prefab['name']}")
          
          # å¦‚æœæ˜¯ push è§¦å‘
          else:
              print("ğŸ“ Detecting changes from git push...")
              
              # è·å–ä¸Šä¸€æ¬¡æäº¤çš„æ–‡ä»¶
              import subprocess
              
              try:
                  old_content = subprocess.check_output(
                      ['git', 'show', 'HEAD~1:prefabs/releases/community-prefabs.json'],
                      stderr=subprocess.DEVNULL
                  ).decode('utf-8')
                  old_data = json.loads(old_content)
              except:
                  old_data = []
              
              try:
                  new_content = subprocess.check_output(
                      ['git', 'show', 'HEAD:prefabs/releases/community-prefabs.json'],
                      stderr=subprocess.DEVNULL
                  ).decode('utf-8')
                  new_data = json.loads(new_content)
              except:
                  new_data = []
              
              old_dict = {(item['id'], item['version']): item for item in old_data}
              new_dict = {(item['id'], item['version']): item for item in new_data}
              
              # æ‰¾å‡ºæ–°å¢æˆ–ä¿®æ”¹çš„æ¡ç›®
              changed = []
              for key, item in new_dict.items():
                  if key not in old_dict or item != old_dict[key]:
                      changed.append(item)
              
              if not changed:
                  print("No changes detected")
              elif len(changed) > 1:
                  print(f"Warning: Multiple changes detected ({len(changed)}), deploying all:")
                  for item in changed:
                      print(f"  - {item['id']}@{item['version']}")
          
          # è¾“å‡ºåˆ° GitHub Actionsï¼ˆä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼é¿å… JSON è½¬ä¹‰é—®é¢˜ï¼‰
          import uuid
          delimiter = f"ghadelimiter_{uuid.uuid4()}"
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changed_entries<<{delimiter}\n")
              f.write(json.dumps(changed))
              f.write(f"\n{delimiter}\n")
              f.write(f"has_changes={'true' if changed else 'false'}\n")
          PYTHON_SCRIPT

      - name: Download and deploy prefabs
        if: steps.extract.outputs.has_changes == 'true'
        env:
          FACTORY_URL: ${{ secrets.PREFAB_FACTORY_DEPLOY_URL }}
          WEBHOOK_SECRET: ${{ secrets.PREFAB_FACTORY_WEBHOOK_SECRET }}
        run: |
          # è¯»å–å˜æ›´çš„æ¡ç›®
          CHANGED_ENTRIES='${{ steps.extract.outputs.changed_entries }}'

          # éå†æ¯ä¸ªå˜æ›´çš„æ¡ç›®ï¼Œä¸‹è½½ .whl å¹¶ä¸Šä¼ åˆ° factory
          echo "$CHANGED_ENTRIES" | python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import sys
          import tempfile
          from pathlib import Path
          from urllib.parse import urlparse, urlencode
          from urllib.request import urlopen, Request, urlretrieve
          import mimetypes
          import hashlib
          import hmac

          input_data = sys.stdin.read().strip()
          if not input_data:
              print("::error::No changed entries data received")
              sys.exit(1)
          
          changed_entries = json.loads(input_data)
          factory_url = os.environ.get('FACTORY_URL')
          webhook_secret = os.environ.get('WEBHOOK_SECRET', '')

          if not factory_url:
              print("::warning::PREFAB_FACTORY_DEPLOY_URL secret is not set")
              print("â„¹ï¸  Skipping deployment trigger. Configure this secret to enable automatic deployment.")
              sys.exit(0)

          # è§£æ factory URLï¼ˆç¡®ä¿æ˜¯ /v1/deploy ç«¯ç‚¹ï¼‰
          parsed = urlparse(factory_url)
          if not parsed.path or parsed.path == '/':
              deploy_url = factory_url.rstrip('/') + '/v1/deploy'
          else:
              deploy_url = factory_url

          for entry in changed_entries:
              prefab_id = entry['id']
              version = entry['version']
              entry_repo_url = entry['repo_url'].rstrip('/')

              # æ„é€  .whl ä¸‹è½½ URL
              # æ³¨æ„ï¼šPython wheel æ–‡ä»¶åä¼šå°†è¿å­—ç¬¦è½¬æ¢ä¸ºä¸‹åˆ’çº¿
              wheel_name = prefab_id.replace('-', '_')
              whl_url = f"{entry_repo_url}/releases/download/v{version}/{wheel_name}-{version}-py3-none-any.whl"

              print(f"ğŸ“¦ Processing {prefab_id}@{version}")
              print(f"   Download URL: {whl_url}")

              try:
                  # ä¸‹è½½ .whl æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
                  with tempfile.TemporaryDirectory() as temp_dir:
                      whl_filename = f"{wheel_name}-{version}-py3-none-any.whl"
                      whl_path = Path(temp_dir) / whl_filename

                      print(f"â¬‡ï¸  Downloading .whl file...")
                      urlretrieve(whl_url, whl_path)
                      file_size = whl_path.stat().st_size
                      print(f"âœ“ Downloaded: {whl_filename} ({file_size:,} bytes)")

                      # è®¡ç®—æ–‡ä»¶ hash ç”¨äºç­¾å
                      file_content = whl_path.read_bytes()
                      file_hash = hashlib.sha256(file_content).hexdigest()
                      
                      # è®¡ç®—ç­¾åï¼ˆå¦‚æœé…ç½®äº† secretï¼‰
                      signature = None
                      if webhook_secret:
                          # ç­¾åè´Ÿè½½æ ¼å¼ï¼šprefab_id|version|file_hash
                          signature_payload = f"{prefab_id}|{version}|{file_hash}"
                          mac = hmac.new(
                              webhook_secret.encode(),
                              msg=signature_payload.encode(),
                              digestmod=hashlib.sha256
                          )
                          signature = f"sha256={mac.hexdigest()}"
                          print(f"ğŸ” Signature generated for payload: {signature_payload}")

                      # å‡†å¤‡ multipart/form-data ä¸Šä¼ 
                      print(f"â¬†ï¸  Uploading to factory: {deploy_url}")

                      # æ„å»º multipart form dataï¼ˆæ‰‹åŠ¨æ„å»ºï¼Œé¿å…ä¾èµ– requests åº“ï¼‰
                      boundary = '----WebKitFormBoundary' + os.urandom(16).hex()
                      parts = []

                      # æ·»åŠ æ–‡æœ¬å­—æ®µ
                      for field_name, field_value in [
                          ('prefab_id', prefab_id),
                          ('version', version)
                      ]:
                          parts.append(f'--{boundary}'.encode())
                          parts.append(f'Content-Disposition: form-data; name="{field_name}"'.encode())
                          parts.append(b'')
                          parts.append(str(field_value).encode())

                      # æ·»åŠ æ–‡ä»¶å­—æ®µ
                      parts.append(f'--{boundary}'.encode())
                      parts.append(
                          f'Content-Disposition: form-data; name="whl_file"; filename="{whl_filename}"'.encode()
                      )
                      parts.append(b'Content-Type: application/octet-stream')
                      parts.append(b'')
                      parts.append(file_content)  # ä½¿ç”¨å·²è¯»å–çš„å†…å®¹
                      parts.append(f'--{boundary}--'.encode())

                      # ç»„è£…è¯·æ±‚ä½“
                      body = b'\r\n'.join(parts)

                      # å‘é€è¯·æ±‚
                      headers = {
                          'Content-Type': f'multipart/form-data; boundary={boundary}',
                          'Content-Length': str(len(body))
                      }
                      
                      # æ·»åŠ ç­¾å headerï¼ˆå¦‚æœæœ‰ï¼‰
                      if signature:
                          headers['X-Hub-Signature-256'] = signature

                      request = Request(deploy_url, data=body, headers=headers, method='POST')
                      with urlopen(request, timeout=60) as response:
                          response_data = response.read().decode('utf-8')
                          status_code = response.status

                          if status_code in (200, 202):
                              print(f"âœ… Deployment triggered for {prefab_id}@{version}")
                              print(f"   Response: {response_data}")
                          else:
                              print(f"::error::Failed to deploy {prefab_id}@{version}")
                              print(f"   Status: {status_code}")
                              print(f"   Response: {response_data}")
                              sys.exit(1)

              except Exception as e:
                  print(f"::error::Failed to process {prefab_id}@{version}: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          print(f"\nâœ… All {len(changed_entries)} deployment(s) triggered successfully")
          PYTHON_SCRIPT

      - name: No changes detected
        if: steps.extract.outputs.has_changes != 'true'
        run: |
          echo "â„¹ï¸  No new or modified prefab entries detected in this push"
