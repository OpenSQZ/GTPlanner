name: Prefab Deploy Webhook

on:
  push:
    branches:
      - main
    paths:
      - 'prefabs/releases/community-prefabs.json'

jobs:
  trigger-deployment:
    name: Trigger Prefab Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if community-prefabs.json changed
        id: check_changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "prefabs/releases/community-prefabs.json"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ community-prefabs.json has been updated"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è community-prefabs.json was not changed"
          fi
      
      - name: Extract changed prefab
        if: steps.check_changes.outputs.changed == 'true'
        id: extract_prefab
        run: |
          # ÊèêÂèñÊñ∞Â¢ûÁöÑ prefab Êù°ÁõÆ
          git show HEAD:prefabs/releases/community-prefabs.json > current.json
          git show HEAD^:prefabs/releases/community-prefabs.json > previous.json || echo "[]" > previous.json
          
          # ÊâæÂá∫Êñ∞Â¢ûÁöÑÊù°ÁõÆÔºàÁÆÄÂåñÁâàÔºåÂÆûÈôÖÂ∫îËØ•Áî® jq ÂÅöÂ∑ÆÈõÜÔºâ
          echo "üì¶ Prefab update detected"
          cat current.json | jq '.' > /tmp/prefab_update.json
      
      - name: Send webhook to deployment service
        if: steps.check_changes.outputs.changed == 'true'
        env:
          DEPLOY_WEBHOOK_URL: ${{ secrets.PREFAB_DEPLOY_WEBHOOK_URL }}
          DEPLOY_WEBHOOK_SECRET: ${{ secrets.PREFAB_DEPLOY_WEBHOOK_SECRET }}
        run: |
          if [ -z "$DEPLOY_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è Warning: PREFAB_DEPLOY_WEBHOOK_URL not configured"
            echo "Skipping webhook trigger. Configure this secret to enable automatic deployment."
            exit 0
          fi
          
          # ËØªÂèñÊõ¥Êñ∞ÁöÑ prefab ÂàóË°®
          PAYLOAD=$(cat /tmp/prefab_update.json)
          
          # ÁîüÊàê HMAC Á≠æÂêç
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$DEPLOY_WEBHOOK_SECRET" | sed 's/^.* //')
          
          # ÂèëÈÄÅ webhook
          HTTP_CODE=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" \
            -X POST "$DEPLOY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -H "X-GitHub-Event: push" \
            -d "$PAYLOAD")
          
          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response:"
          cat /tmp/webhook_response.txt
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Webhook sent successfully"
          else
            echo "‚ùå Webhook failed with status code: $HTTP_CODE"
            exit 1
          fi
      
      - name: Deployment notification
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "üöÄ Prefab deployment triggered"
          echo "The deployment service will process the update shortly."

