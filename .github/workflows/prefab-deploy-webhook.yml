name: Prefab Deploy on Merge

# å½“ PR åˆå¹¶åˆ° main æ—¶è§¦å‘éƒ¨ç½²ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
    paths:
      - 'prefabs/releases/community-prefabs.json'
  workflow_dispatch:
    inputs:
      prefab_id:
        description: 'Prefab ID to deploy (e.g., llm-client)'
        required: true
        type: string
      version:
        description: 'Version to deploy (e.g., 1.0.1)'
        required: true
        type: string

jobs:
  # æ–°å¢ï¼šæ„å»ºé¢„åˆ¶ä»¶ç´¢å¼•
  build-index:
    name: Build Prefab Index
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -q requests

      - name: Build prefab index
        env:
          VECTOR_SERVICE_URL: ${{ secrets.VECTOR_SERVICE_URL }}
        run: |
          python3 prefabs/releases/scripts/build_index.py \
            --vector-service-url "$VECTOR_SERVICE_URL" \
            --input prefabs/releases/community-prefabs.json

      - name: Index build summary
        if: success()
        run: |
          echo "âœ… Prefab index built successfully"
          echo "   The vector service now has the latest prefab data"

      - name: Index build failed
        if: failure()
        run: |
          echo "âŒ Failed to build prefab index"
          echo "   Please check the vector service URL and logs above"

  # ç°æœ‰çš„éƒ¨ç½² jobï¼Œæ·»åŠ ä¾èµ–å…³ç³»
  trigger-deployment:
    name: Trigger Prefab Factory Deployment
    runs-on: ubuntu-latest
    needs: build-index  # ç­‰å¾…ç´¢å¼•æ„å»ºå®Œæˆ

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿å¯¹æ¯”ï¼ˆä»…åœ¨ push è§¦å‘æ—¶éœ€è¦ï¼‰

      - name: Extract changed entry
        id: extract
        env:
          MANUAL_PREFAB_ID: ${{ github.event.inputs.prefab_id }}
          MANUAL_VERSION: ${{ github.event.inputs.version }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          import os

          manual_prefab_id = os.environ.get('MANUAL_PREFAB_ID')
          manual_version = os.environ.get('MANUAL_VERSION')

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘
          if manual_prefab_id and manual_version:
              print(f"ğŸ”§ Manual deployment triggered for {manual_prefab_id}@{manual_version}")
              
              # ä» community-prefabs.json ä¸­è¯»å–æŒ‡å®šçš„ prefab
              with open('prefabs/releases/community-prefabs.json') as f:
                  all_prefabs = json.load(f)
              
              # æŸ¥æ‰¾åŒ¹é…çš„ prefab
              target_prefab = None
              for prefab in all_prefabs:
                  if prefab['id'] == manual_prefab_id and prefab['version'] == manual_version:
                      target_prefab = prefab
                      break
              
              if not target_prefab:
                  print(f"::error::Prefab {manual_prefab_id}@{manual_version} not found in community-prefabs.json")
                  sys.exit(1)
              
              changed = [target_prefab]
              print(f"âœ“ Found prefab: {target_prefab['name']}")
          
          # å¦‚æœæ˜¯ push è§¦å‘
          else:
              print("ğŸ“ Detecting changes from git push...")
              
              # è·å–ä¸Šä¸€æ¬¡æäº¤çš„æ–‡ä»¶
              import subprocess
              
              try:
                  old_content = subprocess.check_output(
                      ['git', 'show', 'HEAD~1:prefabs/releases/community-prefabs.json'],
                      stderr=subprocess.DEVNULL
                  ).decode('utf-8')
                  old_data = json.loads(old_content)
              except:
                  old_data = []
              
              try:
                  new_content = subprocess.check_output(
                      ['git', 'show', 'HEAD:prefabs/releases/community-prefabs.json'],
                      stderr=subprocess.DEVNULL
                  ).decode('utf-8')
                  new_data = json.loads(new_content)
              except:
                  new_data = []
              
              old_dict = {(item['id'], item['version']): item for item in old_data}
              new_dict = {(item['id'], item['version']): item for item in new_data}
              
              # æ‰¾å‡ºæ–°å¢æˆ–ä¿®æ”¹çš„æ¡ç›®
              changed = []
              for key, item in new_dict.items():
                  if key not in old_dict or item != old_dict[key]:
                      changed.append(item)
              
              if not changed:
                  print("No changes detected")
              elif len(changed) > 1:
                  print(f"Warning: Multiple changes detected ({len(changed)}), deploying all:")
                  for item in changed:
                      print(f"  - {item['id']}@{item['version']}")
          
          # è¾“å‡ºåˆ° GitHub Actionsï¼ˆä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼é¿å… JSON è½¬ä¹‰é—®é¢˜ï¼‰
          import uuid
          delimiter = f"ghadelimiter_{uuid.uuid4()}"
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changed_entries<<{delimiter}\n")
              f.write(json.dumps(changed))
              f.write(f"\n{delimiter}\n")
              f.write(f"has_changes={'true' if changed else 'false'}\n")
          PYTHON_SCRIPT

      - name: Download and deploy prefabs
        if: steps.extract.outputs.has_changes == 'true'
        env:
          FACTORY_URL: ${{ secrets.PREFAB_FACTORY_DEPLOY_URL }}
          WEBHOOK_SECRET: ${{ secrets.PREFAB_FACTORY_WEBHOOK_SECRET }}
          CHANGED_ENTRIES: ${{ steps.extract.outputs.changed_entries }}
        run: |
          # å®‰è£… httpxï¼ˆç”¨äºæ­£ç¡®å¤„ç† multipart/form-dataï¼‰
          pip3 install -q httpx
          
          # éå†æ¯ä¸ªå˜æ›´çš„æ¡ç›®ï¼Œä¸‹è½½ .whl å¹¶ä¸Šä¼ åˆ° factory
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import sys
          import tempfile
          from pathlib import Path
          from urllib.parse import urlparse
          from urllib.request import urlretrieve
          import hashlib
          import hmac
          import httpx

          # ä»ç¯å¢ƒå˜é‡è¯»å–å˜æ›´æ¡ç›®ï¼ˆé¿å… heredoc ä¸ç®¡é“å†²çªï¼‰
          input_data = os.environ.get('CHANGED_ENTRIES', '').strip()
          if not input_data:
              print("::error::No changed entries data received")
              sys.exit(1)
          
          changed_entries = json.loads(input_data)
          factory_url = os.environ.get('FACTORY_URL')
          webhook_secret = os.environ.get('WEBHOOK_SECRET', '')

          if not factory_url:
              print("::warning::PREFAB_FACTORY_DEPLOY_URL secret is not set")
              print("â„¹ï¸  Skipping deployment trigger. Configure this secret to enable automatic deployment.")
              sys.exit(0)

          # è§£æ factory URLï¼ˆç¡®ä¿æ˜¯ /v1/deploy ç«¯ç‚¹ï¼‰
          parsed = urlparse(factory_url)
          if not parsed.path or parsed.path == '/':
              deploy_url = factory_url.rstrip('/') + '/v1/deploy'
          else:
              deploy_url = factory_url

          for entry in changed_entries:
              prefab_id = entry['id']
              version = entry['version']
              entry_repo_url = entry['repo_url'].rstrip('/')

              # æ„é€  .whl ä¸‹è½½ URL
              # æ³¨æ„ï¼šPython wheel æ–‡ä»¶åä¼šå°†è¿å­—ç¬¦è½¬æ¢ä¸ºä¸‹åˆ’çº¿
              wheel_name = prefab_id.replace('-', '_')
              whl_url = f"{entry_repo_url}/releases/download/v{version}/{wheel_name}-{version}-py3-none-any.whl"

              print(f"ğŸ“¦ Processing {prefab_id}@{version}")
              print(f"   Download URL: {whl_url}")

              try:
                  # ä¸‹è½½ .whl æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
                  with tempfile.TemporaryDirectory() as temp_dir:
                      whl_filename = f"{wheel_name}-{version}-py3-none-any.whl"
                      whl_path = Path(temp_dir) / whl_filename

                      print(f"â¬‡ï¸  Downloading .whl file...")
                      urlretrieve(whl_url, whl_path)
                      file_size = whl_path.stat().st_size
                      print(f"âœ“ Downloaded: {whl_filename} ({file_size:,} bytes)")

                      # è®¡ç®—æ–‡ä»¶ hash ç”¨äºç­¾å
                      file_content = whl_path.read_bytes()
                      file_hash = hashlib.sha256(file_content).hexdigest()
                      
                      # è®¡ç®—ç­¾åï¼ˆå¦‚æœé…ç½®äº† secretï¼‰
                      signature = None
                      if webhook_secret:
                          # ç­¾åè´Ÿè½½æ ¼å¼ï¼šprefab_id|version|file_hash
                          signature_payload = f"{prefab_id}|{version}|{file_hash}"
                          mac = hmac.new(
                              webhook_secret.encode(),
                              msg=signature_payload.encode(),
                              digestmod=hashlib.sha256
                          )
                          signature = f"sha256={mac.hexdigest()}"
                          print(f"ğŸ” Signature generated for payload: {signature_payload}")

                      # å‡†å¤‡ multipart/form-data ä¸Šä¼ 
                      print(f"â¬†ï¸  Uploading to factory: {deploy_url}")

                      # ä½¿ç”¨ httpx ä¸Šä¼ ï¼ˆè‡ªåŠ¨å¤„ç† multipart/form-data æ ¼å¼ï¼‰
                      files = {
                          'whl_file': (whl_filename, file_content, 'application/octet-stream')
                      }
                      data = {
                          'prefab_id': prefab_id,
                          'version': version
                      }
                      headers = {}
                      if signature:
                          headers['X-Hub-Signature-256'] = signature
                      
                      try:
                          # åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆç¦ç”¨ SSL éªŒè¯ä»¥æ”¯æŒè‡ªç­¾åè¯ä¹¦ï¼‰
                          with httpx.Client(verify=False, timeout=60.0) as client:
                              response = client.post(
                                  deploy_url,
                                  files=files,
                                  data=data,
                                  headers=headers
                              )
                              
                              if response.status_code in (200, 202):
                                  print(f"âœ… Deployment triggered for {prefab_id}@{version}")
                                  print(f"   Response: {response.text}")
                              else:
                                  print(f"::error::Failed to deploy {prefab_id}@{version}")
                                  print(f"   Status: {response.status_code}")
                                  print(f"   Response: {response.text}")
                                  sys.exit(1)
                      except Exception as upload_error:
                          print(f"::error::Failed to upload {prefab_id}@{version}: {upload_error}")
                          raise

              except Exception as e:
                  print(f"::error::Failed to process {prefab_id}@{version}: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          print(f"\nâœ… All {len(changed_entries)} deployment(s) triggered successfully")
          PYTHON_SCRIPT

      - name: No changes detected
        if: steps.extract.outputs.has_changes != 'true'
        run: |
          echo "â„¹ï¸  No new or modified prefab entries detected in this push"
