{% extends "base.html" %}

{% block title %}GTPlanner èŠå¤©ç•Œé¢{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Sidebar: Session List -->
        <div class="col-md-3 border-end bg-light">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> ä¼šè¯åˆ—è¡¨</h6>
                <button class="btn btn-sm btn-primary" onclick="showCreateSessionModal()">
                    <i class="bi bi-plus"></i>
                </button>
            </div>
            <div class="p-2" id="sessionList" style="height: calc(100vh - 200px); overflow-y: auto;">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <p class="mt-2 small">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="col-md-9 d-flex flex-column">
            <!-- Chat Header -->
            <div class="p-3 border-bottom bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0" id="chatTitle">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¼šè¯å¼€å§‹å¯¹è¯</h5>
                        <small class="text-muted" id="chatSessionId"></small>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                            <i class="bi bi-trash"></i> æ¸…ç©º
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportChat()">
                            <i class="bi bi-download"></i> å¯¼å‡º
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3 bg-light" id="messagesArea" style="height: calc(100vh - 300px);">
                <div class="text-center text-muted mt-5" id="welcomeMessage">
                    <i class="bi bi-robot" style="font-size: 4rem; opacity: 0.3;"></i>
                    <p class="mt-3">æ¬¢è¿ä½¿ç”¨ GTPlanner æ™ºèƒ½åŠ©æ‰‹</p>
                    <p class="small">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯ï¼Œæˆ–åˆ›å»ºæ–°ä¼šè¯å¼€å§‹å¯¹è¯</p>
                </div>
                <div id="messagesList"></div>
            </div>

            <!-- Input Area -->
            <div class="p-3 border-top bg-white">
                <div class="input-group">
                    <textarea class="form-control" id="messageInput" rows="2"
                              placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                              onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendButton" disabled>
                        <i class="bi bi-send"></i> å‘é€
                    </button>
                </div>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <small class="text-muted">æç¤º: æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</small>
                    <div class="language-selector">
                        <select class="form-select form-select-sm" id="languageSelect" style="width: auto;">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="fr">FranÃ§ais</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Session Modal -->
<div class="modal fade" id="createSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> åˆ›å»ºæ–°ä¼šè¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createSessionForm">
                    <div class="mb-3">
                        <label for="newSessionTitle" class="form-label">ä¼šè¯æ ‡é¢˜</label>
                        <input type="text" class="form-control" id="newSessionTitle" required
                               placeholder="ä¾‹å¦‚ï¼šè®¾è®¡ç”µå•†å¹³å°">
                    </div>
                    <div class="mb-3">
                        <label for="newProjectStage" class="form-label">é¡¹ç›®é˜¶æ®µ</label>
                        <select class="form-select" id="newProjectStage">
                            <option value="requirements" selected>éœ€æ±‚åˆ†æ</option>
                            <option value="design">è®¾è®¡</option>
                            <option value="development">å¼€å‘</option>
                            <option value="testing">æµ‹è¯•</option>
                            <option value="deployment">éƒ¨ç½²</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createNewSession()">
                    <i class="bi bi-check-circle"></i> åˆ›å»ºå¹¶å¼€å§‹å¯¹è¯
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€çŠ¶æ€
let currentSessionId = null;
let currentSessionTitle = null;
let dialogueHistory = [];
let eventSource = null;

// å·¥å…·å‡½æ•°
function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function repr(str) {
    // æ˜¾ç¤ºå­—ç¬¦ä¸²çš„åŸå§‹å†…å®¹ï¼ŒåŒ…æ‹¬ç‰¹æ®Šå­—ç¬¦
    if (typeof str !== 'string') return String(str);
    return str.replace(/[\r\n\t]/g, (c) => {
        switch (c) {
            case '\r': return '\\r';
            case '\n': return '\\n';
            case '\t': return '\\t';
            default: return c;
        }
    });
}

// åŠ è½½ä¼šè¯åˆ—è¡¨
async function loadSessions() {
    try {
        const response = await fetch('/admin/api/sessions?status=active&limit=50');
        const data = await response.json();

        if (data.success) {
            renderSessionList(data.sessions);
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
        showAlert('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥', 'danger');
    }
}

// æ¸²æŸ“ä¼šè¯åˆ—è¡¨
function renderSessionList(sessions) {
    const container = document.getElementById('sessionList');

    if (sessions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <p class="mb-0">æš‚æ— ä¼šè¯</p>
                <button class="btn btn-sm btn-primary mt-2" onclick="showCreateSessionModal()">
                    åˆ›å»ºæ–°ä¼šè¯
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = sessions.map(session => `
        <div class="session-item p-2 mb-2 rounded cursor-pointer ${session.session_id === currentSessionId ? 'bg-primary text-white' : 'bg-white'}"
             onclick="selectSession('${session.session_id}', '${escapeHtml(session.title)}')"
             style="cursor: pointer; border: 1px solid #dee2e6;">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold small">${escapeHtml(session.title)}</div>
                    <div class="small text-muted ${session.session_id === currentSessionId ? 'text-white-50' : ''}"
                         style="font-size: 0.75rem;">${session.total_messages || 0} æ¡æ¶ˆæ¯</div>
                </div>
                ${session.session_id === currentSessionId ? '<i class="bi bi-check-circle"></i>' : ''}
            </div>
        </div>
    `).join('');
}

// é€‰æ‹©ä¼šè¯
async function selectSession(sessionId, title) {
    currentSessionId = sessionId;
    currentSessionTitle = title;

    // æ›´æ–°UI
    document.getElementById('chatTitle').textContent = title;
    document.getElementById('chatSessionId').textContent = `Session ID: ${sessionId}`;
    document.getElementById('sendButton').disabled = false;

    // åŠ è½½å¯¹è¯å†å²
    await loadDialogueHistory(sessionId);

    // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
    loadSessions();
}

// åŠ è½½å¯¹è¯å†å²
async function loadDialogueHistory(sessionId) {
    try {
        const response = await fetch(`/admin/api/sessions/${sessionId}`);
        const data = await response.json();

        if (data.success) {
            dialogueHistory = data.messages.map(msg => ({
                role: msg.role,
                content: msg.content,
                timestamp: msg.timestamp
            }));

            renderMessages();

            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }
    } catch (error) {
        console.error('Error loading dialogue history:', error);
    }
}

// æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
function renderMessages() {
    const container = document.getElementById('messagesList');
    const welcomeMessage = document.getElementById('welcomeMessage');

    if (dialogueHistory.length === 0) {
        welcomeMessage.style.display = 'block';
        container.innerHTML = '';
        return;
    }

    welcomeMessage.style.display = 'none';

    container.innerHTML = dialogueHistory.map((msg, index) => {
        const isUser = msg.role === 'user';
        return `
            <div class="message mb-3 ${isUser ? 'text-end' : ''}">
                <div class="d-inline-block ${isUser ? 'bg-primary text-white' : 'bg-white'} rounded p-3"
                     style="max-width: 70%; border: 1px solid ${isUser ? 'transparent' : '#dee2e6'};">
                    <div class="small mb-1 ${isUser ? 'text-white' : 'text-muted'}">
                        ${isUser ? 'ä½ ' : 'GTPlanner'} â€¢ ${formatTime(msg.timestamp)}
                    </div>
                    <div class="message-content" style="white-space: pre-wrap;">${escapeHtml(msg.content)}</div>
                </div>
            </div>
        `;
    }).join('');
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;
    if (!currentSessionId) {
        showAlert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¼šè¯', 'warning');
        return;
    }

    console.log('=== å¼€å§‹å‘é€æ¶ˆæ¯ ===');
    console.log('ä¼šè¯ID:', currentSessionId);
    console.log('æ¶ˆæ¯å†…å®¹:', message);
    console.log('å¯¹è¯å†å²é•¿åº¦:', dialogueHistory.length);

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    const userMessage = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    };
    dialogueHistory.push(userMessage);

    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';

    // æ¸²æŸ“æ¶ˆæ¯
    renderMessages();
    scrollToBottom();

    // ç¦ç”¨å‘é€æŒ‰é’®
    document.getElementById('sendButton').disabled = true;

    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    addLoadingIndicator();

    try {
        // è°ƒç”¨GTPlanner API
        const language = document.getElementById('languageSelect').value;

        const requestData = {
            session_id: currentSessionId,
            dialogue_history: dialogueHistory,
            session_metadata: { language: language }
        };

        console.log('å‘é€è¯·æ±‚åˆ°:', '/api/chat/agent');
        console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));

        const response = await fetch('/api/chat/agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

        if (!response.ok) {
            const errorText = await response.text();
            console.error('APIé”™è¯¯å“åº”:', errorText);
            throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
        }

        // å¤„ç†SSEæµ
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        let messageElement = null;
        let chunkCount = 0;
        let buffer = '';  // ç”¨äºç´¯ç§¯ä¸å®Œæ•´çš„JSONæ•°æ®

        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
        removeLoadingIndicator();

        // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯å ä½ç¬¦
        messageElement = addAssistantMessagePlaceholder();

        console.log('å¼€å§‹è¯»å–SSEæµ...');

        let hasReceivedData = false;

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                // å¤„ç†æœ€åå‰©ä½™çš„bufferæ•°æ®
                if (buffer.trim()) {
                    console.log('å¤„ç†æœ€åçš„bufferæ•°æ®');
                    try {
                        const data = JSON.parse(buffer.slice(6));
                        assistantMessage = processSSEEvent(data, assistantMessage, messageElement);
                    } catch (e) {
                        console.warn('æœ€åçš„bufferä¹Ÿæ— æ³•è§£æ:', buffer.substring(0, 100));
                    }
                }
                console.log('SSEæµè¯»å–å®Œæˆï¼Œå…±å¤„ç†', chunkCount, 'ä¸ªæ•°æ®å—');
                break;
            }

            const chunk = decoder.decode(value, { stream: true });
            if (chunkCount < 5) {  // åªæ‰“å°å‰5ä¸ªæ•°æ®å—
                console.log('ğŸ“¦ æ”¶åˆ°æ•°æ®å— (åŸå§‹å†…å®¹):', repr(chunk.substring(0, 300)));
            }
            buffer += chunk;

            // å°è¯•æŒ‰è¡Œåˆ†å‰²å¹¶å¤„ç†å®Œæ•´çš„è¡Œ
            let lines;
            let lastNewlineIndex = buffer.lastIndexOf('\n');

            if (lastNewlineIndex >= 0) {
                lines = buffer.substring(0, lastNewlineIndex).split('\n');
                buffer = buffer.substring(lastNewlineIndex + 1);
            } else {
                // æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œç»§ç»­ç­‰å¾…
                lines = [];
            }

            for (const line of lines) {
                if (!line.trim()) {
                    if (chunkCount < 10) console.log('âšª ç©ºè¡Œ');
                    continue;
                }

                if (chunkCount < 10) {
                    if (line.startsWith('event:')) {
                        console.log('ğŸ”µ äº‹ä»¶ç±»å‹è¡Œ:', line);
                    } else if (line.startsWith('data:')) {
                        console.log('ğŸŸ¢ æ•°æ®è¡Œ (å‰100å­—ç¬¦):', line.substring(0, 100));
                    } else {
                        console.log('âšª å…¶ä»–è¡Œ:', line.substring(0, 50));
                    }
                }

                if (line.startsWith('event:')) {
                    // äº‹ä»¶ç±»å‹è¡Œï¼Œè·³è¿‡
                    continue;
                }

                if (line.startsWith('data:')) {
                    hasReceivedData = true;
                    chunkCount++;
                    // SSEæ ¼å¼: "data: {json content}" æˆ– "data:{json content}"
                    // slice(5) å»æ‰ "data:", trim() å»æ‰å¯èƒ½çš„ç©ºæ ¼
                    const jsonStr = line.slice(5).trim();

                    try {
                        const data = JSON.parse(jsonStr);
                        if (chunkCount <= 5) {
                            console.log('âœ… è§£ææˆåŠŸ, äº‹ä»¶ç±»å‹:', data.event_type || data.type);
                        }
                        assistantMessage = processSSEEvent(data, assistantMessage, messageElement);
                    } catch (e) {
                        if (e instanceof SyntaxError) {
                            if (chunkCount < 10) {
                                console.warn('âš ï¸ JSONä¸å®Œæ•´ï¼Œç­‰å¾…æ›´å¤šæ•°æ®');
                                console.warn('   JSONå­—ç¬¦ä¸²å‰100å­—ç¬¦:', jsonStr.substring(0, 100));
                            }
                            // æ•°æ®ä¿ç•™åœ¨bufferä¸­ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªchunk
                        } else {
                            console.error('âŒ è§£æSSEæ•°æ®å¤±è´¥:', e);
                            console.error('   åŸå§‹è¡Œ (å‰200å­—ç¬¦):', line.substring(0, 200));
                        }
                    }
                }
            }
        }

        if (!hasReceivedData) {
            console.warn('âš ï¸ æ²¡æœ‰æ”¶åˆ°ä»»ä½•SSEæ•°æ®ï¼å¯èƒ½çš„åŸå› ï¼š');
            console.warn('1. APIç«¯ç‚¹è¿”å›äº†ç©ºå“åº”');
            console.warn('2. ä¼šè¯IDæ— æ•ˆ');
            console.warn('3. dialogue_historyæ ¼å¼é”™è¯¯');
            console.warn('4. åç«¯å¤„ç†å‡ºé”™ä½†æ²¡æœ‰è¿”å›é”™è¯¯äº‹ä»¶');
            showAlert('æœªæ”¶åˆ°ä»»ä½•å“åº”ï¼Œè¯·æ£€æŸ¥ä¼šè¯é…ç½®æˆ–è”ç³»ç®¡ç†å‘˜', 'warning');
        }

        // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°å†å²
        if (assistantMessage) {
            dialogueHistory.push({
                role: 'assistant',
                content: assistantMessage,
                timestamp: new Date().toISOString()
            });
            console.log('åŠ©æ‰‹æ¶ˆæ¯å·²æ·»åŠ åˆ°å†å²ï¼Œæ€»æ¶ˆæ¯æ•°:', dialogueHistory.length);
        } else {
            console.warn('è­¦å‘Šï¼šæœªæ”¶åˆ°åŠ©æ‰‹æ¶ˆæ¯');
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
        await saveMessagesToDatabase();

        // æ›´æ–°ä¼šè¯åˆ—è¡¨
        loadSessions();

        console.log('=== æ¶ˆæ¯å‘é€å®Œæˆ ===');

    } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        removeLoadingIndicator();

        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        dialogueHistory.push({
            role: 'assistant',
            content: `æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ`,
            timestamp: new Date().toISOString()
        });
        renderMessages();

        showAlert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'danger');
    } finally {
        document.getElementById('sendButton').disabled = false;
        scrollToBottom();
    }
}

// æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
function addLoadingIndicator() {
    const container = document.getElementById('messagesList');
    const loadingHtml = `
        <div class="message mb-3" id="loadingIndicator">
            <div class="d-inline-block bg-white rounded p-3" style="border: 1px solid #dee2e6;">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span class="small text-muted">GTPlanner æ­£åœ¨æ€è€ƒ...</span>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', loadingHtml);
}

// ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
function removeLoadingIndicator() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
}

// æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯å ä½ç¬¦
function addAssistantMessagePlaceholder() {
    const container = document.getElementById('messagesList');
    const messageHtml = `
        <div class="message mb-3" id="currentAssistantMessage">
            <div class="d-inline-block bg-white rounded p-3"
                 style="max-width: 70%; border: 1px solid #dee2e6;">
                <div class="small mb-1 text-muted">
                    GTPlanner â€¢ ${formatTime(new Date().toISOString())}
                </div>
                <div class="message-content" style="white-space: pre-wrap;"></div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', messageHtml);
    return document.querySelector('#currentAssistantMessage .message-content');
}

// å¤„ç†SSEäº‹ä»¶
function processSSEEvent(data, assistantMessage, messageElement) {
    console.log('å¤„ç†SSEäº‹ä»¶:', data);

    // å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
    if (data.event_type === 'conversation_start') {
        console.log('å¯¹è¯å¼€å§‹:', data);
    } else if (data.event_type === 'assistant_message_start') {
        console.log('åŠ©æ‰‹æ¶ˆæ¯å¼€å§‹');
    } else if (data.event_type === 'assistant_message_chunk') {
        // è¿½åŠ æ¶ˆæ¯ç‰‡æ®µ
        if (data.data && data.data.content) {
            assistantMessage += data.data.content;
            updateAssistantMessage(messageElement, assistantMessage);
        }
    } else if (data.event_type === 'assistant_message_end') {
        console.log('åŠ©æ‰‹æ¶ˆæ¯ç»“æŸ');
    } else if (data.event_type === 'conversation_end') {
        console.log('å¯¹è¯ç»“æŸ:', data.data);
    } else if (data.event_type === 'processing_status') {
        console.log('å¤„ç†çŠ¶æ€:', data.data?.status_message);
    } else if (data.event_type === 'error') {
        console.error('é”™è¯¯äº‹ä»¶:', data.data?.error_message);
        showAlert(`é”™è¯¯: ${data.data?.error_message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
    } else if (data.event_type === 'heartbeat') {
        console.log('å¿ƒè·³');
    } else {
        console.log('æœªçŸ¥äº‹ä»¶ç±»å‹:', data.event_type, data);
    }

    return assistantMessage;
}

// æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
function updateAssistantMessage(element, content) {
    if (element) {
        element.textContent = content;
        scrollToBottom();
    }
}

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
async function saveMessagesToDatabase() {
    if (!currentSessionId) return;

    // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–äº†å®ç°ï¼Œå®é™…ä¸Šåº”è¯¥è°ƒç”¨APIä¿å­˜æ¶ˆæ¯
    // ç›®å‰GTPlannerçš„æµç¨‹ä¸­ï¼Œæ¶ˆæ¯ä¼šåœ¨Agentå¤„ç†æ—¶è‡ªåŠ¨ä¿å­˜
}

// æ˜¾ç¤ºåˆ›å»ºä¼šè¯æ¨¡æ€æ¡†
function showCreateSessionModal() {
    const modal = new bootstrap.Modal(document.getElementById('createSessionModal'));
    modal.show();
}

// åˆ›å»ºæ–°ä¼šè¯
async function createNewSession() {
    const title = document.getElementById('newSessionTitle').value.trim();
    const projectStage = document.getElementById('newProjectStage').value;

    if (!title) {
        showAlert('è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜', 'warning');
        return;
    }

    try {
        const response = await fetch('/admin/api/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: title,
                project_stage: projectStage
            })
        });

        const data = await response.json();

        if (data.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('createSessionModal'));
            modal.hide();

            // æ¸…ç©ºè¡¨å•
            document.getElementById('createSessionForm').reset();

            // é€‰æ‹©æ–°ä¼šè¯
            selectSession(data.session_id, data.session.title);

            showAlert('ä¼šè¯åˆ›å»ºæˆåŠŸ', 'success');
        } else {
            showAlert('åˆ›å»ºä¼šè¯å¤±è´¥', 'danger');
        }
    } catch (error) {
        console.error('Error creating session:', error);
        showAlert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message, 'danger');
    }
}

// æ¸…ç©ºèŠå¤©
function clearChat() {
    if (!currentSessionId) return;

    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å†å²å—ï¼Ÿ')) {
        return;
    }

    dialogueHistory = [];
    renderMessages();
    showAlert('å¯¹è¯å†å²å·²æ¸…ç©º', 'info');
}

// å¯¼å‡ºå¯¹è¯
function exportChat() {
    if (dialogueHistory.length === 0) {
        showAlert('æš‚æ— å¯¹è¯å†…å®¹å¯å¯¼å‡º', 'warning');
        return;
    }

    const content = dialogueHistory.map(msg => {
        const role = msg.role === 'user' ? 'ä½ ' : 'GTPlanner';
        const time = formatTime(msg.timestamp);
        return `[${time}] ${role}:\n${msg.content}\n`;
    }).join('\n' + '-'.repeat(50) + '\n');

    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_${currentSessionId}_${new Date().getTime()}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    showAlert('å¯¹è¯å·²å¯¼å‡º', 'success');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // 5ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadSessions().then(() => {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„é€‰çš„ä¼šè¯
        const preSelectedSessionId = sessionStorage.getItem('selectedSessionId');
        const preSelectedTitle = sessionStorage.getItem('selectedSessionTitle');

        if (preSelectedSessionId && preSelectedTitle) {
            // æ¸…é™¤sessionStorage
            sessionStorage.removeItem('selectedSessionId');
            sessionStorage.removeItem('selectedSessionTitle');

            // è‡ªåŠ¨é€‰ä¸­è¯¥ä¼šè¯
            selectSession(preSelectedSessionId, preSelectedTitle);
        }
    });
});
</script>

<style>
.message-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.session-item:hover {
    background-color: #f8f9fa !important;
}

.session-item.bg-primary:hover {
    background-color: #0b5ed7 !important;
}

.cursor-pointer {
    cursor: pointer;
}

#messagesArea {
    scroll-behavior: smooth;
}
</style>
{% endblock %}
